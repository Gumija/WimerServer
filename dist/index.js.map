{"version":3,"sources":["../src/index.js"],"names":["app","upload","dest","mariaDB","host","user","password","documents","insert","prepare","selectAll","selectById","update","highlights","delete","selectByDocumentAndUser","use","static","resolve","__dirname","json","get","req","res","query","documentId","params","userId","err","rows","console","log","sendStatus","id","body","post","start","end","class","container","download","path","title","single","file","originalname","type","mimetype","encoding","info","insertId","sendFile","PORT","process","env","listen"],"mappings":"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","file":"index.js","sourcesContent":["import bodyParser from 'body-parser';\nimport cookieParser from 'cookie-parser';\nimport express from 'express';\nimport session from 'express-session';\nimport MariaSQLClient from 'mariasql';\nimport morgan from 'morgan';\nimport multer from 'multer';\nimport passport from 'passport';\nimport GoogleAuth from 'passport-google-oauth2';\nimport path from 'path';\n\nlet app = express();\nlet upload = multer({ dest: 'uploads/' });\nlet mariaDB = new MariaSQLClient({\n  host: '127.0.0.1',\n  user: 'root',\n  password: '',\n})\n\nlet documents = {\n  insert: mariaDB.prepare(\n    'INSERT INTO wimer.documents \\\n     VALUES (:id, :title, :path, :type, :encoding)'),\n  selectAll: mariaDB.prepare(\n    'SELECT * \\\n     FROM wimer.documents'\n  ),\n  selectById: mariaDB.prepare(\n    'SELECT * \\\n     FROM wimer.documents \\\n     WHERE id = :id'\n  ),\n  update: mariaDB.prepare(\n    'UPDATE wimer.documents \\\n     SET title = :title \\\n     WHERE id = :id'\n  ),\n}\n\nlet highlights = {\n  insert: mariaDB.prepare(\n    'INSERT INTO wimer.highlights \\\n     VALUES (:id, :start, :end, :class, :container, :documentId, :userId'\n  ),\n  delete: mariaDB.prepare(\n    'DELETE FROM wimer.highlights \\\n     WHERE id = :id \\\n     AND document_id = :documentId \\\n     AND user_id = :userId'\n  ),\n  selectByDocumentAndUser: mariaDB.prepare(\n    'SELECT * \\\n     FROM wimer.highlights \\\n     WHERE document_id = :documentId \\\n     AND user_id = :userId'\n  )\n}\n\n// logger\napp.use(morgan(':remote-addr - :remote-user [:date[clf]] \":method :url HTTP/:http-version\" :status :res[content-length] :response-time ms'));\n// Serve static assets\napp.use(express.static(path.resolve(__dirname, '..', 'WimerReact/build')));\napp.use(bodyParser.json());\n\napp.get('/highlight/:documentId/:userId', (req, res) => {\n  mariaDB.query(highlights.selectByDocumentAndUser({\n    documentId: req.params.documentId,\n    userId: req.params.userId,\n  }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.json(rows);\n    }\n  )\n})\n\napp.delete('/highlight', (req, res) => {\n  mariaDB.query(highlights.delete({\n    id: req.body.id,\n    documentId: req.body.documentId,\n    userId: req.body.userId,\n  }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.sendStatus(200);\n    }\n  )\n})\n\napp.post('/highlight', (req, res) => {\n  // save highlight from body\n  mariaDB.query(highlights.insert({\n    id: req.body.id,\n    start: req.body.start,\n    end: req.body.end,\n    class: req.body.class,\n    container: req.body.container,\n    documentId: req.body.documentId,\n    userId: req.body.userId,\n  }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.sendStatus(200);\n    }\n  )\n})\n\napp.get('/documents/download/:id', (req, res) => {\n  mariaDB.query(documents.selectById({ id: req.params.id }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.download(rows[0].path);\n    }\n  )\n})\n\napp.post('/documents/update/:id', (req, res) => {\n  mariaDB.query(documents.update({ title: req.body.title, id: req.params.id }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.json(rows);\n    }\n  )\n})\n\napp.get('/documents/:id', (req, res) => {\n  mariaDB.query(documents.selectById({ id: req.params.id }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.json(rows);\n    }\n  )\n})\n\napp.get('/documents', (req, res) => {\n  mariaDB.query(documents.selectAll(),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.json(rows);\n    }\n  )\n})\n\napp.post('/upload', upload.single('doc'), (req, res) => {\n  let file = req.file;\n  // save document info to db\n  mariaDB.query(documents.insert({\n    id: 0,\n    title: file.originalname,\n    path: file.path,\n    type: file.mimetype,\n    encoding: file.encoding,\n  }),\n    (err, rows) => {\n      if (err) {\n        console.log(err);\n        res.sendStatus(500);\n      }\n      console.log(rows);\n      res.json({ id: rows.info.insertId });\n    }\n  )\n})\n\n\n\n// Always return the main index.html, so react-router render the route in the client\napp.get('*', (req, res) => {\n  res.sendFile(path.resolve(__dirname, '..', 'WimerReact/build', 'index.html'));\n});\n\nconst PORT = process.env.PORT || 3001;\n\napp.listen(PORT, () => {\n  console.log(`App listening on port ${PORT}!`);\n});"]}